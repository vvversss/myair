<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Корзина</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Корзина</h1>

<a href="index.html" class="btn btn-outline" style="margin-bottom:20px; display:inline-block;">← На главную</a>

<div id="cartItems" class="catalog-grid"></div>

<div class="cart-footer">
    <button id="placeOrderBtn" class="btn">Оформить заказ</button>
</div>

<div id="toast" class="toast"></div>

<script src="script.js"></script>
<script>
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function showCart() {
    const user = JSON.parse(localStorage.getItem('tg_user'));
    if (!user) {
        document.getElementById('cartItems').innerHTML = '<p>Сначала авторизуйтесь</p>';
        return;
    }

    const cart = JSON.parse(localStorage.getItem('cart_' + user.id) || '[]');
    const container = document.getElementById('cartItems');
    container.innerHTML = '';

    if (!cart.length) {
        container.innerHTML = '<p>Корзина пуста</p>';
        return;
    }

    cart.forEach((item, index) => {
        container.innerHTML += `
            <div class="product cart-item">
                <h3>${item.name}</h3>
                <p>${item.description}</p>
                <div class="price">${item.price}</div>
                <button class="btn btn-outline" onclick="removeItem(${index})">Удалить</button>
            </div>
        `;
    });
}


function removeItem(index) {
    const user = JSON.parse(localStorage.getItem('tg_user'));
    if (!user) return showToast('Сначала авторизуйтесь через Telegram');
    const key = 'cart_' + user.id;
    let cart = JSON.parse(localStorage.getItem(key) || '[]');
    cart.splice(index, 1);
    localStorage.setItem(key, JSON.stringify(cart));
    showCart();
    showToast('Товар удалён из корзины');
}

document.getElementById('placeOrderBtn').onclick = function() {
    const user = JSON.parse(localStorage.getItem('tg_user'));
    const cart = getCart();
    if (!cart.length) return showToast('Корзина пуста');

    fetch('https://myair-zjra.onrender.com/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, cart })
    })
    .then(res => res.json())
    .then(data => {
        showToast(data.message || 'Заказ отправлен');
        clearCart();
        showCart();
    })
    .catch(() => showToast('Ошибка при отправке заказа'));
};

showCart();
</script>

</body>
</html>
